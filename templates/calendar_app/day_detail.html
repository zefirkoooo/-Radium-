{% extends 'calendar_app/base.html' %}
{% load static %}

{% block extra_css %}
<link href="{% static 'css/day_detail.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="meal-selection-container">
    <div class="header-card">
        <div class="header-content">
            <h2 class="day-title">
                <i class="fas fa-utensils"></i>
                Меню на {{ day_menu.date|date:"d.m.Y" }}
                <span class="badge bg-primary">{{ day_menu.get_day_display }}</span>
            </h2>
        </div>
        {% if day_menu.date < next_week_start %}
        <div class="locked-notice">
            <i class="fas fa-lock"></i>
            Меню текущей недели недоступно для изменений
        </div>
        {% endif %}
    </div>

    <form method="post" class="meal-selection-form">
        {% csrf_token %}

        {% for category, icon, emoji, field, meals in categories %}
            <div class="category-section {% if field == 'selected_side' %}sides-category{% endif %}">
                <div class="category-header">
                    <i class="{{ icon }}"></i>
                    <h3>{{ category }}</h3>
                </div>
                <div class="meals-grid">
                    {% for meal in meals %}
                    <div class="meal-card {% if day_menu.date < next_week_start %}locked{% endif %}">
                        <label for="{{ field }}_{{ meal.id }}" {% if day_menu.date < next_week_start %}class="disabled"{% endif %}>
                            <input type="radio"
                                   name="{{ field }}"
                                   value="{{ meal.id }}"
                                   id="{{ field }}_{{ meal.id }}"
                                   {% if field == 'selected_main' %}
                                   data-is-complete="{{ meal.is_complete_dish|yesno:'true,false' }}"
                                   {% endif %}
                                   {% if form.instance|default:None %}
                                       {% if field == 'selected_salad' and form.instance.selected_salad == meal %}checked{% endif %}
                                       {% if field == 'selected_soup' and form.instance.selected_soup == meal %}checked{% endif %}
                                       {% if field == 'selected_main' and form.instance.selected_main == meal %}checked{% endif %}
                                       {% if field == 'selected_side' and form.instance.selected_side == meal %}checked{% endif %}
                                       {% if field == 'selected_bakery' and form.instance.selected_bakery == meal %}checked{% endif %}
                                   {% endif %}
                                   required>
                            <span class="meal-icon">{{ emoji }}</span>
                            <span class="meal-name">{% if meal.description %}{{ meal.name }} ({{ meal.description }}){% else %}{{ meal.name }}{% endif %}</span>
                            {% if meal.is_complete_dish %}
                            <span class="complete-dish-badge" title="Полноценное блюдо">
                                <i class="fas fa-check-circle"></i>
                            </span>
                            {% endif %}
                            {% if day_menu.date < next_week_start %}
                            <span class="locked-icon">
                                <i class="fas fa-lock"></i>
                            </span>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}

        {% if day_menu.date >= next_week_start %}
        <div class="buttons-container">
            <button type="submit" name="save" class="submit-button">
                <i class="fas fa-check-circle"></i>
                Сохранить выбор
            </button>

            <button type="submit" name="save_and_next" class="next-button">
                <i class="fas fa-arrow-right"></i>
                Следующий день
            </button>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/day_detail.js' %}"></script>
{% endblock %}